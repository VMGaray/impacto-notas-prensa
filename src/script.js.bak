document.addEventListener('DOMContentLoaded', function() {

    // ============================================
    // GENERAR O RECUPERAR ID DE SESIN
    // ============================================
    let sessionId = sessionStorage.getItem('idSesion');
    if (!sessionId) {
        // Generar nuevo ID de sesi贸n 煤nico
        sessionId = crypto.randomUUID();
        sessionStorage.setItem('idSesion', sessionId);
        console.log(' Nuevo ID de sesi贸n generado:', sessionId);
    } else {
        console.log(' ID de sesi贸n recuperado:', sessionId);
    }

    // Funci贸n de ayuda para garantizar que los valores num茅ricos sean seguros
    const ensureNumber = (val) => {
        // Convierte explicitamente a n煤mero, o usa 0 si falla (NaN, null, undefined)
        const num = Number(val);
        return (typeof num === 'number' && !isNaN(num)) ? num : 0;
    };

    // ============================================
    // LGICA PRINCIPAL DEL FORMULARIO
    // ============================================
    document.getElementById('impact-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const organizacion = document.getElementById('organizacion').value;
        const tema = document.getElementById('tema').value;
        const fecha = document.getElementById('fecha').value;

        const WEBHOOK_URL = "https://n8n.icc-e.org/webhook-test/0c67f547-a6b6-431a-9368-68dd2d8a4a8b";

        const data = {
            organizacion: organizacion,
            tema: tema,
            fecha: fecha,
            id_sesion: sessionId
        };

        // Muestra el loader y limpia los resultados
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('metrics-output').innerHTML = '';
        document.getElementById('global-result').textContent = '';

        fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(async response => {
            console.log('Estado HTTP:', response.status);
            console.log('Headers:', response.headers);

            if (!response.ok) {
              throw new Error(`Error en el servidor de an谩lisis (HTTP Status: ${response.status})`);
            }

            const text = await response.text();
            console.log('Respuesta del servidor (texto):', text);

            if (!text || text.trim() === '') {
                throw new Error('El servidor devolvi贸 una respuesta vac铆a. Verifique que el workflow de N8N est茅 ACTIVO y configurado correctamente.');
            }

            try {
                let parsed = JSON.parse(text);

                // 锔 Si n8n devuelve un array, tomar el primer elemento
                if (Array.isArray(parsed)) {
                    parsed = parsed[0];
                }

                // 锔 Si n8n envuelve los datos en un objeto "output", extraerlos
                if (parsed.output && typeof parsed.output === 'object') {
                    parsed = parsed.output;
                }

                return parsed;
            } catch (e) {
                // Si el parseo falla, mostramos el error original
                throw new Error(`El servidor no devolvi贸 JSON v谩lido. Respuesta: ${text.substring(0, 200)}`);
            }
        })
        .then(analysisResult => {
            console.log('Respuesta completa de la API:', analysisResult);
            console.log('Objeto analisis:', analysisResult.analisis);

            // 锔 MANEJO ESPECIAL: Si n8n devuelve sin_cobertura: true
            if (analysisResult.sin_cobertura === true) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                document.querySelector('.subtitle').style.display = 'none';
                document.querySelector('.freemium-note').style.display = 'none';
                document.getElementById('impact-form').style.display = 'none';

                document.getElementById('res-organizacion').textContent = organizacion;
                document.getElementById('res-tema').textContent = tema;
                document.getElementById('res-resumen-ejecutivo').textContent = analysisResult.mensaje || 'No se encontr贸 cobertura sobre este tema.';

                const globalResultDiv = document.getElementById('global-result');
                globalResultDiv.textContent = analysisResult.mensaje || 'No se encontr贸 cobertura sobre este tema.';
                globalResultDiv.className = 'global-result rojo';

                document.getElementById('ai-badge').style.display = 'none';
                document.getElementById('metrics-output').innerHTML = '';

                window.currentAnalysis = {
                    organizacion,
                    tema,
                    fecha,
                    sin_cobertura: true,
                    mensaje: analysisResult.mensaje,
                    resultado_global: analysisResult.mensaje || 'Sin cobertura',
                    cobertura_medios: 0,
                    cobertura_radio: 0,
                    cobertura_tv: 0,
                    cobertura_emisiones: 0,
                    duracion_dias: 0,
                    alcance_estimado: 0,
                    menciones: { detalle: [] } 
                };

                return; // Salir temprano
            }

            // 锔 VALIDACIN: Verificar que resultado_global exista antes de usarlo
            if (!analysisResult.resultado_global) {
                throw new Error('El servidor no devolvi贸 un resultado_global v谩lido. Verifique la configuraci贸n del workflow de n8n.');
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.querySelector('.subtitle').style.display = 'none';
            document.querySelector('.freemium-note').style.display = 'none';

            document.getElementById('res-organizacion').textContent = organizacion;
            document.getElementById('res-tema').textContent = tema;
            document.getElementById('impact-form').style.display = 'none';


            // Muestra el resumen ejecutivo de la IA
            if (analysisResult.resumen_ejecutivo) {
                document.getElementById('res-resumen-ejecutivo').textContent = analysisResult.resumen_ejecutivo;
            }

              // Obtener contexto de menciones para usar m谩s adelante
          const contexto = analysisResult.menciones?.detalle || [];
          // Filtrar solo radio y TV
            const mencionesValidas = contexto.filter(m => {
            const tipoNorm = (m?.tipo || '').trim().toLowerCase();
            return tipoNorm === 'radio' || tipoNorm === 'tv';
        });



            // Mostrar badge de IA si el an谩lisis fue generado con Claude AI
            const aiBadge = document.getElementById('ai-badge');
            if (analysisResult.ai_model === 'claude-3.5-sonnet' && analysisResult.ai_provider === 'anthropic') {
                aiBadge.style.display = 'flex';
                aiBadge.querySelector('.ai-text').innerHTML = 'An谩lisis generado con <strong>Claude AI 3.5 Sonnet (Anthropic)</strong>';
            } else if (analysisResult.ai_model === 'fallback') {
                aiBadge.style.display = 'flex';
                aiBadge.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                aiBadge.querySelector('.ai-text').innerHTML = '<strong>An谩lisis b谩sico</strong> (IA no disponible temporalmente)';
            } else {
                aiBadge.style.display = 'none';
            }

            const globalResultDiv = document.getElementById('global-result');
            globalResultDiv.textContent = `Resultado global: ${analysisResult.resultado_global}`;
            // Pintar en verde todos los casos positivos (que contengan "funcion贸")
            // Pintar en rojo solo "No funcion贸" o similares negativos
            const esPositivo = analysisResult.resultado_global.toLowerCase().includes('funcion贸') &&
                              !analysisResult.resultado_global.toLowerCase().startsWith('no');
            globalResultDiv.className = esPositivo ? 'global-result verde' : 'global-result rojo';

           // ===============================================
const metricsOutput = document.getElementById('metrics-output');

const coberturaMedios = ensureNumber(analysisResult.cobertura_medios);
const coberturaRadio = ensureNumber(analysisResult.cobertura_radio);
const coberturaTV = ensureNumber(analysisResult.cobertura_tv);
const coberturaEmisiones = ensureNumber(analysisResult.cobertura_emisiones);
const duracionDias = ensureNumber(analysisResult.duracion_dias);
const alcanceEstimado = analysisResult.alcance_estimado || "0 personas";
const rangoFechas = analysisResult.rango_fechas || "";

const metrics = {
    'Cobertura de medios': coberturaMedios.toLocaleString(),
    'Cobertura de radio': coberturaRadio.toLocaleString(),
    'Cobertura de televisi贸n': coberturaTV.toLocaleString(),
    'Cantidad de emisiones': coberturaEmisiones.toLocaleString(),
    'Alcance estimado': alcanceEstimado,
    'Duraci贸n en d铆as': `${duracionDias.toLocaleString()} ${rangoFechas}`
};

const analysisDetail = analysisResult.analisis;

for (const key in analysisDetail) {
    const detail = analysisDetail[key];
    let metricDisplayName = key.charAt(0).toUpperCase() + key.slice(1);

    if (key === 'cobertura') metricDisplayName = 'Cobertura de medios';
    if (key === 'alcance') metricDisplayName = 'Alcance estimado';
    if (key === 'duracion') metricDisplayName = 'Duraci贸n en d铆as';
    if (key === 'emisiones') metricDisplayName = 'Cantidad de emisiones';

    let metricValue = metrics[metricDisplayName] || '';

    metricsOutput.innerHTML += `
        <div class="metric-box ${detail.color}">
            <strong>${metricDisplayName}:</strong> ${metricValue}
        </div>
    `;
}

// Cobertura separada visualmente (fuera del an谩lisisDetail)
metricsOutput.innerHTML += `
    <div class="metric-box verde">
        <strong>Cobertura de radio:</strong> ${metrics['Cobertura de radio']}
    </div>
    <div class="metric-box verde">
        <strong>Cobertura de televisi贸n:</strong> ${metrics['Cobertura de televisi贸n']}
    </div>
    <div class="metric-box verde">
        <strong>Menciones encontradas (Radio/TV):</strong> ${mencionesValidas.length}
    </div>
`;

// Mostrar recomendaciones que vienen de N8N/Claude AI
if (analysisResult.recomendaciones && Array.isArray(analysisResult.recomendaciones) && analysisResult.recomendaciones.length > 0) {
    // Determinar color basado en el resultado global
    const resultadoGlobal = (analysisResult.resultado_global || '').toLowerCase();
    const esPositivo = resultadoGlobal.includes('funcion贸') && !resultadoGlobal.startsWith('no');
    const colorRecomendaciones = esPositivo ? 'verde' : 'rojo';

    metricsOutput.innerHTML += `
        <div class="metric-box ${colorRecomendaciones}">
            <strong>Recomendaciones:</strong>
            <ul style="margin-top: 10px; padding-left: 20px;">
                ${analysisResult.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
        </div>
    `;
}
            window.currentAnalysis = {
    ...analysisResult,
    organizacion,
    tema,
    fecha,
    menciones: {
    detalle: mencionesValidas
  }
};

        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').innerHTML = `<h2 style="color:red;">Error en el an谩lisis</h2><p>No se pudo completar la solicitud. Verifique que el workflow de n8n est茅 **ACTIVO**.</p><p>Detalle: ${error.message}</p>`;
            console.error('Fetch error:', error);
        });
    });

    // ============================================
    // FUNCIONALIDADES ADICIONALES (Resto del c贸digo)
    // ============================================

    // Variable global para almacenar an谩lisis guardados
    let savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses')) || [];

    // 1. VER DETALLES AMPLIADOS
document.getElementById('btn-detalles').addEventListener('click', function() {
    const modal = document.getElementById('modal-detalles');
    const modalBody = document.getElementById('modal-detalles-body');

    if (!window.currentAnalysis) {
        alert('No hay an谩lisis disponible para mostrar detalles.');
        return;
    }

    const analysis = window.currentAnalysis;

    const aiInfoHTML = analysis.ai_model === 'claude-3.5-sonnet'
        ? `<div class="detail-item" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left-color: #667eea;">
            <h4> An谩lisis con Inteligencia Artificial</h4>
            <p><strong>Modelo:</strong> Claude 3.5 Sonnet</p>
            <p><strong>Proveedor:</strong> Anthropic</p>
            <p><strong>Tipo de an谩lisis:</strong> Inteligencia artificial generativa</p>
            <p><strong>Capacidades:</strong> An谩lisis contextual, interpretaci贸n de datos y generaci贸n de recomendaciones personalizadas basadas en patrones identificados en los datos del endpoint.</p>
        </div>`
        : analysis.ai_model === 'fallback'
        ? `<div class="detail-item" style="background: #fef3c7; border-left-color: #f59e0b;">
            <h4>锔 An谩lisis b谩sico</h4>
            <p><strong>Tipo:</strong> Algoritmo b谩sico (IA no disponible)</p>
            <p><strong>Motivo:</strong> ${analysis.error || 'IA temporalmente no disponible'}</p>
        </div>`
        : '';

    modalBody.innerHTML = `
        <div class="detail-item">
            <h4>Informaci贸n general</h4>
            <p><strong>Organizaci贸n:</strong> ${analysis.organizacion}</p>
            <p><strong>Tema:</strong> ${analysis.tema}</p>
            <p><strong>Fecha:</strong> ${analysis.fecha}</p>
            <p><strong>Resultado global:</strong> ${analysis.resultado_global}</p>
        </div>

        ${aiInfoHTML}

        <div class="detail-item">
            <h4>Resumen ejecutivo del an谩lisis (Claude AI)</h4>
            <p>${analysis.resumen_ejecutivo || 'No disponible, verifique la respuesta de la IA.'}</p>
        </div>

        <div class="detail-item">
            <h4>Cobertura de medios</h4>
            <p><strong>Cantidad:</strong> ${analysis.cobertura_medios || 0} medios</p>
            <p><strong>Descripci贸n:</strong> Indica cu谩ntos medios de comunicaci贸n publicaron informaci贸n sobre la nota de prensa. Una cobertura alta sugiere que el mensaje tuvo una amplia difusi贸n medi谩tica.</p>
        </div>

        <div class="detail-item">
            <h4>Cantidad de emisiones</h4>
            <p><strong>Total:</strong> ${analysis.cobertura_emisiones || 0}</p>
            <p><strong>Descripci贸n:</strong> N煤mero de emisiones 煤nicas en radio y televisi贸n que difundieron la nota. Refleja la diversidad de medios que participaron en la cobertura.</p>
        </div>

        <div class="detail-item">
            <h4>Alcance estimado</h4>
            <p><strong>Personas impactadas:</strong> ${(analysis.alcance_estimado || 0).toLocaleString()}</p>
            <p><strong>Descripci贸n:</strong> Estimaci贸n del n煤mero total de personas que potencialmente vieron o fueron expuestas al mensaje a trav茅s de los diferentes medios de comunicaci贸n.</p>
        </div>

        <div class="detail-item">
            <h4>Duraci贸n en agenda medi谩tica</h4>
            <p><strong>D铆as activos:</strong> ${analysis.duracion_dias || 0} d铆as</p>
            <p><strong>Descripci贸n:</strong> Tiempo durante el cual la nota de prensa se mantuvo relevante en los medios. Una mayor duraci贸n indica que el tema gener贸 inter茅s sostenido.</p>
        </div>
    `;

   const menciones = analysis.menciones?.detalle || [];

const mencionesValidas = menciones.filter(m => {
  if (typeof m === 'object') {
    const tipoNorm = (m.tipo || '').trim().toLowerCase();
    return tipoNorm === 'tv' || tipoNorm === 'radio';
  }
  return false; // si es string o no tiene tipo, lo descartamos
});

if (mencionesValidas.length > 0) {
  modalBody.innerHTML += `
    <div class="detail-item">
      <h4>Menciones encontradas</h4>
      <p><strong>Cantidad:</strong> ${mencionesValidas.length} menciones</p>
      <p><strong>Descripci贸n:</strong> A continuaci贸n se muestran fragmentos de las noticias de radio y TV donde se menciona la organizaci贸n o el tema analizado.</p>
      <div style="margin-top: 15px;">
        ${mencionesValidas.map((m, index) => {
          const extracto = m.extracto || m.texto || "";
          const fecha = m.fecha || "";
          const medio = m.medio || "";
          const tipo = m.tipo || "";
          const tipoNorm = tipo.trim().toLowerCase();
          const colorBadge = tipoNorm === 'tv' ? '#48bb78' : '#4299e1';

          return `
            <div class="contexto-item" style="margin-bottom: 20px; padding: 15px; background-color: #f7fafc; border-left: 4px solid ${colorBadge}; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="color: #2b6cb0; font-size: 1.05em;"> Menci贸n ${index + 1}</strong>
                <span style="background-color: ${colorBadge}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; text-transform: uppercase;">${tipo}</span>
              </div>

              ${extracto ? `
                <div style="margin-bottom: 12px;">
                  <p style="margin: 0; font-style: italic; color: #2d3748; line-height: 1.6; background-color: white; padding: 10px; border-radius: 4px;">
                    "${extracto}"
                  </p>
                </div>
              ` : ''}

              <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; font-size: 0.9em;">
                ${medio ? `
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: #718096;"> <strong>Medio:</strong></span>
                    <span style="color: #2d3748;">${medio}</span>
                  </div>
                ` : ''}

                ${fecha ? `
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: #718096;"> <strong>Fecha:</strong></span>
                    <span style="color: #2d3748;">${fecha}</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
} else {
  modalBody.innerHTML += `
    <div class="detail-item">
      <h4>Menciones encontradas</h4>
      <p><strong>Cantidad:</strong> 0 menciones v谩lidas</p>
      <p><strong>Descripci贸n:</strong> No se encontraron menciones de radio o TV en los medios consultados.</p>
    </div>
  `;
}


    //  Recomendaciones (en detalles ampliados)
    if (analysis.recomendaciones && Array.isArray(analysis.recomendaciones) && analysis.recomendaciones.length > 0) {
        modalBody.innerHTML += `
            <div class="detail-item">
                <h4>Recomendaciones</h4>
                <p><strong>Cantidad:</strong> ${analysis.recomendaciones.length} recomendaciones</p>
                <p><strong>Descripci贸n:</strong> Sugerencias objetivas basadas en el an谩lisis de las m茅tricas y el resultado global.</p>
                <ul style="margin-top: 15px; padding-left: 20px;">
                    ${analysis.recomendaciones.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join("")}
                </ul>
            </div>
        `;
    }

    modal.style.display = 'block';
});


    // 2. COMPARAR CON OTRAS NOTAS
    // 锔 FUNCIONALIDAD COMENTADA - VERSIN GRATUITA
    // Descomentar cuando se implemente la versi贸n Pro
    /*
    document.getElementById('btn-comparar').addEventListener('click', function() {
        const modal = document.getElementById('modal-comparar');
        updateComparisonList();
        modal.style.display = 'block';
    });

    document.getElementById('btn-guardar-actual').addEventListener('click', function() {
        if (!window.currentAnalysis) {
            alert('No hay an谩lisis actual para guardar.');
            return;
        }

        savedAnalyses.push({
            ...window.currentAnalysis,
            savedAt: new Date().toISOString()
        });

        localStorage.setItem('savedAnalyses', JSON.stringify(savedAnalyses));
        updateComparisonList();
        alert('An谩lisis guardado exitosamente.');
    });

    document.getElementById('btn-limpiar-comparacion').addEventListener('click', function() {
        if (confirm('驴Est谩 seguro de que desea eliminar todos los an谩lisis guardados?')) {
            savedAnalyses = [];
            localStorage.removeItem('savedAnalyses');
            updateComparisonList();
        }
    });

    function updateComparisonList() {
        const listDiv = document.getElementById('comparacion-list');
        const chartDiv = document.getElementById('comparison-chart');

        if (savedAnalyses.length === 0) {
            listDiv.innerHTML = '<p class="info-message">Guarde este an谩lisis y agregue m谩s para comparar.</p>';
            chartDiv.innerHTML = '';
            return;
        }

        let html = '<h3>An谩lisis guardados (' + savedAnalyses.length + ')</h3>';

        savedAnalyses.forEach((analysis, index) => {
            html += `
                <div class="comparison-item">
                    <div>
                        <h4>${analysis.organizacion} - ${analysis.tema}</h4>
                        <p>Fecha: ${analysis.fecha} | Resultado: ${analysis.resultado_global}</p>
                    </div>
                </div>
            `;
        });

        listDiv.innerHTML = html;

        // Crear tabla comparativa
        if (savedAnalyses.length > 0) {
            chartDiv.innerHTML = '<h3>Comparaci贸n de m茅tricas</h3>' + createComparisonTable();
        }
    }

    function createComparisonTable() {
        let tableHTML = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
        tableHTML += '<thead><tr style="background-color: #f7fafc;">';
        tableHTML += '<th style="padding: 12px; border: 1px solid #e2e8f0; text-align: left;">Organizaci贸n</th>';
        tableHTML += '<th style="padding: 12px; border: 1px solid #e2e8f0;">Cobertura</th>';
        tableHTML += '<th style="padding: 12px; border: 1px solid #e2e8f0;">Alcance</th>';
        tableHTML += '<th style="padding: 12px; border: 1px solid #e2e8f0;">Duraci贸n</th>';
        tableHTML += '<th style="padding: 12px; border: 1px solid #e2e8f0;">Resultado</th>';
        tableHTML += '</tr></thead><tbody>';

        savedAnalyses.forEach(analysis => {
            // Pintar en verde todos los casos positivos (que contengan "funcion贸")
            const esPositivo = analysis.resultado_global.toLowerCase().includes('funcion贸') &&
                              !analysis.resultado_global.toLowerCase().startsWith('no');
            const resultColor = esPositivo ? '#48bb78' : '#f56565';
            tableHTML += '<tr>';
            tableHTML += `<td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>${analysis.organizacion}</strong><br><small>${analysis.tema}</small></td>`;
            tableHTML += `<td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${analysis.cobertura_medios || 0}</td>`;
            tableHTML += `<td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${(analysis.alcance_estimado || 0).toLocaleString()}</td>`;
            tableHTML += `<td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${analysis.duracion_dias || 0}</td>`;
            tableHTML += `<td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center; color: ${resultColor}; font-weight: bold;">${analysis.resultado_global}</td>`;
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table></div>';
        return tableHTML;
    }
    */

    // 3. SOLICITAR ANLISIS COMPLETO - Muestra modal antes de descargar
    document.getElementById('btn-analisis-completo').addEventListener('click', function() {
        if (!window.currentAnalysis) {
            alert('No hay an谩lisis disponible para exportar.');
            return;
        }

        // Abrir el modal de descarga
        const modal = document.getElementById('modal-descarga');
        modal.style.display = 'block';
    });

    // Bot贸n DESCARGAR INFORME BSICO (dentro del modal)
    document.getElementById('btn-descargar-basico').addEventListener('click', function() {
        if (!window.currentAnalysis) {
            alert('No hay an谩lisis disponible para exportar.');
            return;
        }

        const analysis = window.currentAnalysis;

        // Crear contenido del reporte
        let reportContent = `ANLISIS COMPLETO DE IMPACTO - NOTA DE PRENSA\n`;
        reportContent += `${'='.repeat(60)}\n\n`;
        reportContent += `INFORMACIN GENERAL\n`;
        reportContent += `Organizaci贸n: ${analysis.organizacion}\n`;
        reportContent += `Tema: ${analysis.tema}\n`;
        reportContent += `Fecha de Publicaci贸n: ${analysis.fecha}\n`;
        reportContent += `Fecha de An谩lisis: ${new Date().toLocaleDateString()}\n`;
        reportContent += `Resultado Global: ${analysis.resultado_global}\n\n`;

        // Agregar informaci贸n de IA
        if (analysis.ai_model === 'claude-3.5-sonnet') {
            reportContent += `${'='.repeat(60)}\n`;
            reportContent += `ANLISIS CON INTELIGENCIA ARTIFICIAL\n`;
            reportContent += `${'='.repeat(60)}\n`;
            reportContent += `Modelo: Claude 3.5 Sonnet\n`;
            reportContent += `Proveedor: Anthropic\n`;
            reportContent += `Tipo: Inteligencia Artificial generativa\n`;
            reportContent += `Capacidades: An谩lisis contextual, interpretaci贸n de datos\n`;
            reportContent += `              y generaci贸n de recomendaciones personalizadas\n\n`;
        } else if (analysis.ai_model === 'fallback') {
            reportContent += `NOTA: An谩lisis b谩sico generado con algoritmo (IA no disponible)\n`;
            reportContent += `Motivo: ${analysis.error || 'IA temporalmente no disponible'}\n\n`;
        }

        if (analysis.resumen_ejecutivo) {
            reportContent += `${'='.repeat(60)}\n`;
            reportContent += `RESUMEN EJECUTIVO (ANLISIS IA)\n`;
            reportContent += `${'='.repeat(60)}\n`;
            reportContent += `${analysis.resumen_ejecutivo}\n\n`;
        }

        reportContent += `${'='.repeat(60)}\n`;
        reportContent += `MTRICAS DETALLADAS\n`;
        reportContent += `${'='.repeat(60)}\n\n`;

        reportContent += `1. COBERTURA DE MEDIOS\n`;
        reportContent += `   Cantidad: ${analysis.cobertura_medios || 0} medios\n`;
        reportContent += `   Descripci贸n: Indica cu谩ntos medios publicaron sobre la nota.\n\n`;

        reportContent += `2. CANTIDAD DE EMISIONES\n`;
        reportContent += `   Total: ${analysis.cobertura_emisiones || 0}\n`;
        reportContent += `   Descripci贸n: N煤mero de emisiones 煤nicas en radio y televisi贸n que difundieron la nota.\n\n`;

        reportContent += `3. ALCANCE ESTIMADO\n`;
        reportContent += `   Personas impactadas: ${(analysis.alcance_estimado || 0).toLocaleString()}\n`;
        reportContent += `   Descripci贸n: Estimaci贸n del n煤mero de personas expuestas al mensaje.\n\n`;

        reportContent += `4. DURACIN EN AGENDA MEDITICA\n`;
        reportContent += `   D铆as activos: ${analysis.duracion_dias || 0}\n`;
        reportContent += `   Descripci贸n: Tiempo que la nota se mantuvo relevante en medios.\n\n`;

        // Agregar recomendaciones al reporte
        if (analysis.recomendaciones && Array.isArray(analysis.recomendaciones) && analysis.recomendaciones.length > 0) {
            reportContent += `${'='.repeat(60)}\n`;
            reportContent += `RECOMENDACIONES\n`;
            reportContent += `${'='.repeat(60)}\n\n`;
            analysis.recomendaciones.forEach((rec, index) => {
                reportContent += `${index + 1}. ${rec}\n`;
            });
            reportContent += `\n`;
        }

        // Crear y descargar archivo
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Analisis_completo_${analysis.organizacion}_${new Date().getTime()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        // Cerrar el modal
        document.getElementById('modal-descarga').style.display = 'none';

        alert(' An谩lisis completo descargado exitosamente.');
    });

    // Bot贸n VER VERSIN PRO
    document.getElementById('btn-ver-pro').addEventListener('click', function() {
        window.open('mailto:contacto@icc-e.org?subject=Consulta sobre versi贸n Pro - 驴Funcion贸 mi nota de prensa?&body=Hola, me gustar铆a recibir informaci贸n sobre la versi贸n Pro y sus funcionalidades completas.', '_blank');
        // O puedes redirigir a una p谩gina: window.location.href = 'https://tu-sitio.com/version-pro';
    });


    // CERRAR MODALES
    const modals = document.getElementsByClassName('modal');
    const closeButtons = document.getElementsByClassName('close');

    for (let i = 0; i < closeButtons.length; i++) {
        closeButtons[i].onclick = function() {
            this.parentElement.parentElement.style.display = 'none';
        }
    }

    window.onclick = function(event) {
        for (let i = 0; i < modals.length; i++) {
            if (event.target === modals[i]) {
                modals[i].style.display = 'none';
            }
        }
    }

    // ==============================
// FUNCIONALIDADES FREEMIUM / PRO
// ==============================

// Bot贸n: Comparar con otras notas (versi贸n Pro) - Abre modal
document.getElementById('btn-comparar').addEventListener('click', function() {
    const modal = document.getElementById('modal-comparar');
    modal.style.display = 'block';
});

// Bot贸n: Contactar para versi贸n Pro (dentro del modal comparar)
document.getElementById('btn-contactar-pro').addEventListener('click', function() {
    window.open('mailto:contacto@icc-e.org?subject=Consulta sobre versi贸n Pro - Funcionalidad de comparaci贸n&body=Hola, me gustar铆a recibir informaci贸n sobre la versi贸n Pro y espec铆ficamente la funcionalidad de comparaci贸n de an谩lisis.', '_blank');
});

// Bot贸n: Volver (cierra modal comparar)
document.getElementById('btn-cerrar-comparar').addEventListener('click', function() {
    document.getElementById('modal-comparar').style.display = 'none';
});

// 锔 CDIGO DUPLICADO COMENTADO - La funcionalidad de an谩lisis completo ya est谩 implementada arriba
/*
// Bot贸n: Solicitar an谩lisis completo (confirmaci贸n antes de descargar)
document.getElementById('btn-analisis-completo').addEventListener('click', function() {
    const confirmDownload = confirm(
        "Se va a descargar el informe de la versi贸n gratuita con datos b谩sicos de impacto de su nota de prensa.\n\n" +
        "Para un informe completo y funcionalidades Pro, contacte con ventas en: contacto@icc-e.org\n\n" +
        "驴Desea continuar con la descarga?"
    );

    if (!confirmDownload) return;

    // 锔 Asegurate de que tu l贸gica de descarga est茅 dentro de este bloque
    // Si ya ten茅s el c贸digo de descarga implementado, movelo ac谩 adentro
});
*/

// Bot贸n: Analizar otra nota de prensa (resetear formulario)
document.getElementById('btn-reset-form').addEventListener('click', function() {
    // Resetear campos del formulario
    document.getElementById('impact-form').reset();

    // Mostrar nuevamente el formulario
    document.getElementById('impact-form').style.display = 'block';

    // Mostrar los textos introductorios debajo del t铆tulo
    document.querySelector('.subtitle').style.display = 'block';
    document.querySelector('.freemium-note').style.display = 'block';

    // Ocultar resultados y limpiar contenido
    document.getElementById('results').style.display = 'none';
    document.getElementById('metrics-output').innerHTML = '';
    document.getElementById('global-result').textContent = '';
    document.getElementById('ai-badge').style.display = 'none';
    document.getElementById('res-resumen-ejecutivo').textContent = '';
});


}); // CIERRE DOMContentLoaded


